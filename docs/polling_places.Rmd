---
title: "Changes in Polling Places"
subtitle: 
author:
output:
    # pdf_document:
    #   toc: true
    #   keep_tex: true
    html_document:
      highlight: zenburn
      #toc: true
      #toc_float: true
      code_folding: hide
editor_options: 
  chunk_output_type: console
---

```{r global.options, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, 
                      cache = FALSE, 
                      fig.width=8.5, 
                      split = T,
                      fig.align = 'center', 
                      fig.path='figs/',
                      warning=FALSE, 
                      message=FALSE)
```

# Data from the state 

The state posts an xlsx file of polling locations here: https://elections.wi.gov/node/6527

To check it's accuracy, we look up polling locations for addresses in every voting precinct.

```{r}
library(httr)
library(jsonlite)
library(tidyverse)
library(magrittr)

# polling locations posted on website for WI primary
official_locations <- readxl::read_xlsx(here::here("data", "PPL 2020 Partisan Primary 2.xlsx"))

# one address per precinct
addresses <- read_csv(here::here("data", "wisconsin_example_addresses.csv"))

# FIXME DELETE THESE LINES FOR FULL DATA
official_locations %<>% head()
addresses %<>% head()
# /FIXME
```

# Data from the state --> Voter Information Project --> Google Civic's API

Polling locations are sometimes (in the days or weeks before an election) available via the Google Civic API, which uses data collected from states by the Voter Information Project, which notifies users when it posts data here: https://groups.google.com/g/vip-community

Notes about the Google Civic API (see the relevant documentation [here](https://developers.google.com/civic-information/docs/v2/elections/voterInfoQuery))  
- create an API key here: https://console.developers.google.com/apis/credentials  
- remember to authorize you API key  
- calls should not need `electionId`, docs say it is optional  
- `pollingLocations` will not always be returned  
- may great deal more than polling locations  
- may return more than one polling place per input address as a list 



```{r}
# need to get AND authorize an api key
source(here::here("api_key.R"))

# A function to get poll addresses
get_poll <- function(voter_address){
  
  voter_address %<>% 
    str_replace_all(" ", "%20") %>%
    str_remove_all(",")
  
  url <- str_c("https://civicinfo.googleapis.com/civicinfo/v2/voterinfo?address=", 
               voter_address, 
               "&returnAllAvailableData=true&key=", 
               api_key)
  
  
  poll <- GET(url) %>% 
    .$content %>% 
    rawToChar() %>% 
    fromJSON() %>%
    .$pollingLocations %>% # note: there is a lot more than this
    .$address %>% 
    {ifelse(is.null(.), "none", .)}
  
  return(poll)
}

# apply function to addresses
addresses %<>% 
  mutate(voter_address = paste(voting_street_address, voting_city, state_code),  
         PollingPlaceAddress = map(voter_address, get_poll)) 

# expand if there is more then one polling place per address
addresses %<>% unnest(PollingPlaceAddress)
```

## API results not in the state's xlsx file

```{r}
addresses %>% 
  filter(PollingPlaceAddress != "none") %>% # filter out API errors
  anti_join(official_locations) %>% # filter out locations already posted
  select(precinct_name, precinct_id, PollingPlaceAddress) %>%
  knitr::kable()
```

## Cases where Google Civic's API did not return the same address when given polling locations

```{r}
official_locations %>% 
  mutate(PollingPlaceAddress_API = map(PollingPlaceAddress, get_poll)) %>% # get polling places for polling places' addresses
  filter(PollingPlaceAddress_API != PollingPlaceAddress) %>% # mismatches
  select(Muni, ReportingUnit, PollingPlaceName, PollingPlaceAddress, PollingPlaceAddress_API) %>% 
  knitr::kable()
```

## Polling locations not returned by Google Civic's API

```{r}
official_locations %>% 
  anti_join(addresses) %>% # remove ones matched with API
  select(Muni, ReportingUnit, PollingPlaceName, PollingPlaceAddress) %>% 
  knitr::kable()
```

```{r, eval=FALSE}
# for refernce, these may or may not be returned: 
"pollingLocations": [
    {
      "id": string,
      "address": {
        "locationName": string,
        "line1": string,
        "line2": string,
        "line3": string,
        "city": string,
        "state": string,
        "zip": string
      },
      "notes": string,
      "pollingHours": string,
      "name": string,
      "voterServices": string,
      "startDate": string,
      "endDate": string,
      "latitude": double,
      "longitude": double,
      "sources": [
        {
          "name": string,
          "official": boolean
        }
      ]
    }
  ],
  "earlyVoteSites": [
    {
      "id": string,
      "address": {
        "locationName": string,
        "line1": string,
        "line2": string,
        "line3": string,
        "city": string,
        "state": string,
        "zip": string
      },
      "notes": string,
      "pollingHours": string,
      "name": string,
      "voterServices": string,
      "startDate": string,
      "endDate": string,
      "latitude": double,
      "longitude": double,
      "sources": [
        {
          "name": string,
          "official": boolean
        }
      ]
    }
  ],
  "dropOffLocations": [
    {
      "id": string,
      "address": {
        "locationName": string,
        "line1": string,
        "line2": string,
        "line3": string,
        "city": string,
        "state": string,
        "zip": string
      },
      "notes": string,
      "pollingHours": string,
      "name": string,
      "voterServices": string,
      "startDate": string,
      "endDate": string,
      "latitude": double,
      "longitude": double,
      "sources": [
        {
          "name": string,
          "official": boolean
        }
      ]
    }
  ],
```